# Ralph Progress Log
Started: Thu Feb 26 07:24:30 PM -03 2026

## Codebase Patterns
- i18n: Use `t('namespace.key', locale, params?)` from `src/i18n` for translations
- i18n: For client-side JS strings in `<script>` tags, inject `window.__i18n = { key: '${t(...)}' }` at top of script block and reference via `window.__i18n.key`
- i18n: Locale files in `src/i18n/locales/{en,pt,es}.ts` — en.ts is the source of truth, uses `as const`
- i18n: `TranslationData` uses `DeepStringify<typeof en>` so pt/es can have different string values while keeping same shape
- i18n: `TranslationKeys` is derived from en.ts structure — typos in keys caught at build time
- i18n: Interpolation uses `{{variable}}` placeholders in translation strings
- i18n: `getLocale(c)` from `src/i18n` resolves user language from DB via `c.get('user').userId` — falls back to 'en'
- HTMX fragments: When template functions are used by both page renders AND HTMX endpoints, add `locale` param with `= 'en'` default so existing callers don't break
- HTMX fragments: Route handlers serving fragments need `const locale = await getLocale(c)` and pass locale to render functions
- System status: Inline HTML in route handler was extracted to `renderSystemStatusFragment()` in dashboard template for proper i18n
- Routes: All admin page-rendering handlers call `const locale = await getLocale(c)` and pass `locale` to template data
- Routes: Auth pages (login/register) use hardcoded `locale: 'en'` — no authenticated user available
- Templates: All page/layout interfaces have `locale?: string` — optional to avoid breaking non-locale-aware callers
- Layout templates: In `src/templates/layouts/` (NOT `src/templates/pages/`). Import t as `../../i18n`
- Layout templates: Internal render functions (`renderCatalystSidebar`, `renderSidebar`, `renderTopBar`) accept locale as last param with default `'en'`
- Migration banner: Uses `data-template` attribute with `{{count}}` placeholder — JS replaces at runtime via `textEl.getAttribute('data-template').replace('{{count}}', ...)`
- TypeScript: `tsconfig.json` uses strict mode with `noUncheckedIndexedAccess`, `noImplicitReturns`
- Tests: Use vitest with `describe/it/expect` pattern, tests in `src/__tests__/` mirroring source structure
- i18n: Confirmation dialog props (title, message, confirmText, cancelText) accept translated strings directly — no locale param needed on the component itself
- i18n: Private render helpers (e.g. `renderField`, `renderTabContent`, `renderGeneralSettings`) get locale as a param with default `'en'` so they can use `t()` internally
- Pre-existing plugin errors in typecheck (email-templates-plugin, ai-search-plugin, design routes) — ignore these
- Migrations: SQL files in `packages/core/migrations/NNNN_slug.sql`, then run `npx tsx scripts/generate-migrations.ts` to bundle
- Migrations: Service skips "already exists" / "duplicate column name" errors — ALTER TABLE ADD COLUMN is safe even if column exists
- Schema: Drizzle schema in `src/db/schema.ts` — `User`/`NewUser` types auto-derived. Zod schemas via `createInsertSchema`/`createSelectSchema`
---

## 2026-02-26 19:26 - US-001
- Created i18n translation infrastructure: `t()` function, types, 3 locale files (en, pt, es)
- Files created:
  - `packages/core/src/i18n/t.ts` — translation function with fallback + interpolation
  - `packages/core/src/i18n/types.ts` — `TranslationData`, `TranslationKeys`, `Locale` types
  - `packages/core/src/i18n/index.ts` — barrel export
  - `packages/core/src/i18n/locales/en.ts` — English (source of truth, `as const`)
  - `packages/core/src/i18n/locales/pt.ts` — Portuguese
  - `packages/core/src/i18n/locales/es.ts` — Spanish
  - `packages/core/src/__tests__/i18n/t.test.ts` — 37 unit tests
- **Learnings for future iterations:**
  - en.ts uses `as const` for literal types; pt.ts and es.ts use `TranslationData` (which is `DeepStringify<typeof en>`) to allow different string values
  - `TranslationKeys` is derived directly from `typeof en` (not `TranslationData`) to preserve literal key paths
  - Pre-existing typecheck errors exist in plugins (email-templates-plugin, ai-search-plugin, design routes) — not related to i18n
  - Added `common.itemCount` key with `{{count}}` placeholder across all locales for interpolation testing
---

## 2026-02-26 19:33 - US-002
- Added `language` column to users Drizzle schema and created migration
- Files changed:
  - `packages/core/src/db/schema.ts` — added `language: text('language').notNull().default('en')` to users table
  - `packages/core/migrations/0003_add_user_language.sql` — ALTER TABLE migration (safe no-op for databases created from consolidated migration)
  - `packages/core/src/db/migrations-bundle.ts` — regenerated to include migration 0003
- **Learnings for future iterations:**
  - The consolidated migration `0001_initial_schema.sql` already has a `language TEXT DEFAULT 'en'` column (from original migration 004 profile fields) — but the Drizzle schema was missing it
  - The migration service (`src/services/migrations.ts`) skips "already exists" and "duplicate column name" errors, making ALTER TABLE ADD COLUMN migrations safe even if the column already exists
  - Migration naming: `NNNN_slug_name.sql` in `packages/core/migrations/`, then run `npx tsx scripts/generate-migrations.ts` to regenerate the bundle
  - Pre-existing test failures: bootstrap.test.ts (x3), admin-layout-catalyst.test.ts (x2), plus table-sorting, template-renderer, email-renderer — none related to schema changes
---

## 2026-02-26 19:45 - US-003
- Passed locale through all admin route handlers and template signatures
- Files created:
  - `packages/core/src/i18n/get-locale.ts` — `getLocale(c)` helper: queries DB for user language, falls back to 'en'
- Files changed:
  - `packages/core/src/i18n/index.ts` — re-exports `getLocale`
  - 7 route files (`admin-dashboard.ts`, `admin-content.ts`, `admin-users.ts`, `admin-settings.ts`, `admin-plugins.ts`, `admin-logs.ts`, `auth.ts`) — import `getLocale`, call it in page-rendering handlers, pass `locale` to template data
  - 2 layout templates (`admin-layout-catalyst.template.ts`, `admin-layout-v2.template.ts`) — added `locale?: string` to interface
  - 18 page templates — added `locale?: string` to each data interface
- **Learnings for future iterations:**
  - JWT token contains `userId`, `email`, `role` but NOT `language` — must query DB to get language preference
  - Only page-rendering route handlers need locale (not HTMX fragment endpoints, JSON APIs, or redirects)
  - Auth pages (login/register) have no authenticated user — hardcode `locale: 'en'`
  - admin-settings has 3 tab routes (general, migrations, database-tools) — all need locale
  - admin-content has error paths in catch blocks that also render templates — need locale there too
  - admin-users is the largest route file with 5 page-rendering handlers (profile, users list, new user, edit user, activity logs)
  - `locale` is optional in interfaces (`locale?: string`) to keep backward compatibility
---

## 2026-02-26 19:52 - US-004
- Extracted and translated navigation and layout strings in both layout templates
- Files changed:
  - `packages/core/src/i18n/locales/en.ts` — added `layout` namespace (closeMenu, pendingMigrations, viewDetails, signIn, backgroundThemes, customBackgrounds, backgroundDarkness, adjustDarkness) + nav keys (collections, media, fieldTypes, apiSpec)
  - `packages/core/src/i18n/locales/pt.ts` — same structure with Portuguese translations
  - `packages/core/src/i18n/locales/es.ts` — same structure with Spanish translations
  - `packages/core/src/templates/layouts/admin-layout-catalyst.template.ts` — imported `t`, replaced sidebar labels with `t('nav.*', locale)`, user dropdown with `t('nav.myProfile/signOut', locale)`, close menu with `t('layout.closeMenu', locale)`, migration banner with data-template approach, set `<html lang>` dynamically
  - `packages/core/src/templates/layouts/admin-layout-v2.template.ts` — imported `t`, replaced all 13 sidebar labels, top bar user dropdown, "Sign In" link, and background customizer strings with t() calls, set `<html lang>` dynamically
  - `packages/core/src/__tests__/templates/admin-layout-catalyst.test.ts` — updated migration banner test to expect `id="migration-text"` + `data-template` attribute
- **Learnings for future iterations:**
  - Layout templates are in `src/templates/layouts/` NOT `src/templates/pages/` (PRD had wrong path)
  - The catalyst layout has fewer sidebar items (Content, Dashboard, Users, Logs + Settings) vs v2 layout (13 items)
  - `renderAdminLayout()` in v2 just delegates to `renderAdminLayoutCatalyst()` — the actual v2 layout is `adminLayoutV2()`
  - Migration banner text was split between HTML (`<span id>`) and text — refactored to use `data-template` attribute with `{{count}}` placeholder for clean i18n
  - Internal render functions (`renderCatalystSidebar`, `renderSidebar`, `renderTopBar`) are not exported — add locale as last positional param with default `'en'`
  - Pre-existing test failures (2 in catalyst layout, 3 in bootstrap) are unrelated to i18n — they check for menu items that don't exist in catalyst layout
---

## 2026-02-26 20:00 - US-005
- Extracted and translated all Dashboard page strings across all sections
- Files changed:
  - `packages/core/src/i18n/locales/en.ts` — added `dashboard` namespace with 40+ keys (stats, analytics, activity, quick actions, system status, storage)
  - `packages/core/src/i18n/locales/pt.ts` — Portuguese translations for dashboard namespace
  - `packages/core/src/i18n/locales/es.ts` — Spanish translations for dashboard namespace
  - `packages/core/src/templates/pages/admin-dashboard.template.ts` — replaced all hardcoded strings with t() calls; added locale param to `renderStatsCards`, `renderRecentActivity`, `renderStorageUsage`, `renderAnalyticsChart`, `renderQuickActions`, `renderSystemStatus`; created new `renderSystemStatusFragment()` export for HTMX endpoint; translated relative time strings (just now, X minutes ago, etc.)
  - `packages/core/src/routes/admin-dashboard.ts` — added `getLocale(c)` calls to all HTMX fragment endpoints (stats, storage, recent-activity, system-status); replaced inline system-status HTML with `renderSystemStatusFragment()` call; translated error messages in catch blocks
- **Learnings for future iterations:**
  - HTMX fragment endpoints serve HTML independently of the main page — they also need locale passed via `getLocale(c)` in the route handler
  - When a function is used both by page render AND HTMX endpoint, add `locale = 'en'` default param to avoid breaking changes
  - Inline HTML in route handlers should be extracted to template functions for proper i18n (e.g., system-status was inline → now `renderSystemStatusFragment()`)
  - Chart.js labels in `<script>` tags can be translated by injecting translated strings as JS variables: `const reqSecLabel = '${t('dashboard.requestsPerSec', locale)}'`
  - Relative time strings need singular/plural variants (minuteAgo vs minutesAgo) — use separate keys with `{{count}}` interpolation
---

## 2026-02-26 20:08 - US-006
- Extracted and translated all Content List page strings including filters, table headers, actions, bulk actions, and advanced search modal
- Files changed:
  - `packages/core/src/i18n/locales/en.ts` — added `content.list` namespace with 55+ keys (page header, filter labels, status options, table columns, action buttons, bulk actions, advanced search modal)
  - `packages/core/src/i18n/locales/pt.ts` — Portuguese translations for content.list namespace
  - `packages/core/src/i18n/locales/es.ts` — Spanish translations for content.list namespace
  - `packages/core/src/templates/pages/admin-content-list.template.ts` — imported `t`, replaced all hardcoded strings with t() calls; injected `window.__i18n` object for client-side JS strings; passed locale to layout data
- **Learnings for future iterations:**
  - Client-side JS strings (in `<script>` tags) can't use `t()` directly — inject translated strings via `window.__i18n = { key: '${t(...)}' }` at the top of the script block
  - Bulk action dialog messages use `{{count}}` placeholder replaced client-side with `.replace('{{count}}', count)` — same pattern as migration banner's `data-template`
  - Filter bar data object (`FilterBarData`) has labels in its structure — these also need t() calls, not just the HTML
  - The `Refresh` icon conditional uses label comparison (`action.label === 'Refresh'`) — updated to compare against translated label
  - Advanced search modal has its own set of status options separate from the main filter — both need translation
  - Layout data needs `locale` passed explicitly to propagate to the layout template
---

## 2026-02-26 20:15 - US-007
- Extracted and translated all Content Form page strings including section headers, sidebar, action buttons, file upload, confirmation dialogs, and client-side JS strings
- Files changed:
  - `packages/core/src/i18n/locales/en.ts` — added `content.form` namespace with 50+ keys (section headers, sidebar labels, publishing, content info, quick actions, file upload, confirmation dialogs, client-side error messages, type picker page)
  - `packages/core/src/i18n/locales/pt.ts` — Portuguese translations for content.form namespace
  - `packages/core/src/i18n/locales/es.ts` — Spanish translations for content.form namespace
  - `packages/core/src/templates/pages/admin-content-form.template.ts` — imported `t`, replaced all hardcoded strings with t() calls; added locale param to `renderField()` and `getQuillCDNAndInit()`; injected `window.__i18n` for client-side JS strings; passed locale to layout data
  - `packages/core/src/routes/admin-content.ts` — imported `t`, translated type picker page inline strings (back link, heading, subheading)
- **Learnings for future iterations:**
  - `renderField()` is a private function — added locale as 3rd param with default `'en'` to avoid changing the call signature dramatically
  - File upload script (`getFileUploadScript()`) returns static JS — client-side strings use `window.__i18n.key.replace('{{placeholder}}', value)` pattern
  - The Quill editor placeholder is injected server-side into the init script — pass locale to `getQuillCDNAndInit()` and use `t()` there
  - Content form has both server-rendered strings (section headers, labels) and client-side JS strings (upload status, error alerts, version history errors) — both need i18n
  - Confirmation dialog props (title, message, confirmText, cancelText) accept translated strings directly — no locale param needed on the component
  - The type picker page in admin-content route has inline HTML with hardcoded strings — these also need t() calls
  - `common.cancel` and `common.delete` can be reused from the common namespace for dialog buttons
---

## 2026-02-26 20:20 - US-008
- Extracted and translated all User List page strings: page header, stats section, filter bar, table columns, role badges, status badges, action buttons, confirmation dialog, and client-side JS error messages
- Files changed:
  - `packages/core/src/i18n/locales/en.ts` — added `users.list` namespace with 37 keys (page title, stats labels, filter labels, table headers, role names, status badges, confirmation dialog, error messages)
  - `packages/core/src/i18n/locales/pt.ts` — Portuguese translations for users.list namespace
  - `packages/core/src/i18n/locales/es.ts` — Spanish translations for users.list namespace
  - `packages/core/src/templates/pages/admin-users-list.template.ts` — imported `t`, replaced all hardcoded strings with t() calls; used `roleLabels` lookup map for translated role badges; injected `window.__i18n` for client-side JS error string; passed locale to layout data
- **Learnings for future iterations:**
  - Role badges use a dynamic `value.charAt(0).toUpperCase() + value.slice(1)` pattern — replaced with a `roleLabels` Record lookup using translated role names (roleAdmin, roleEditor, etc.)
  - Status badges in the name column reuse `common.active` / `common.inactive` from the common namespace — no need for duplicate keys
  - Filter dropdown options (Active, Inactive, All Users, All Roles) need translation too — easy to miss
  - Button `title` attributes (tooltip text) also need translation (deactivateUser, activateUser)
  - Layout data should include `locale` property to propagate to the layout template for sidebar/navbar translations
---

## 2026-02-26 20:25 - US-009
- Extracted and translated all User Form page strings: admin-user-new, admin-user-edit, and admin-profile templates
- Files changed:
  - `packages/core/src/i18n/locales/en.ts` — added `users.form` namespace with 90+ keys (page titles, field labels, placeholders, section headers, sidebar labels, role descriptions, danger zone, password modal, profile preferences, notifications, security)
  - `packages/core/src/i18n/locales/pt.ts` — Portuguese translations for users.form namespace
  - `packages/core/src/i18n/locales/es.ts` — Spanish translations for users.form namespace
  - `packages/core/src/templates/pages/admin-user-new.template.ts` — imported `t`, replaced all hardcoded strings with t() calls; passed locale to layout data
  - `packages/core/src/templates/pages/admin-user-edit.template.ts` — imported `t`, replaced all hardcoded strings with t() calls; injected `window.__i18n` for client-side JS error messages; translated confirmation dialog props; passed locale to layout data
  - `packages/core/src/templates/pages/admin-profile.template.ts` — imported `t`, replaced all hardcoded strings with t() calls; injected `window.__i18n` for 2FA coming soon alert; translated password modal strings; passed locale to layout data
- **Learnings for future iterations:**
  - Template file names don't always match PRD names — `admin-user-new` (not `admin-users-new`), `admin-user-edit` (not `admin-users-edit`), `admin-profile` (not `admin-users-profile`)
  - The three user form templates share many field labels (firstName, lastName, etc.) but have different contexts — new user has placeholders like "Enter first name", profile has "Enter your first name"
  - Confirmation dialog component accepts translated strings as props (title, message, confirmText, cancelText) — no locale param needed on the component itself
  - Client-side JS alert() calls need `window.__i18n` pattern — e.g. delete error messages and 2FA coming soon message
  - Profile page has a password change modal with its own set of labels — separate from the main form
  - Profile page 2FA toggle is a TODO — just shows an alert, but it still needs i18n
  - The `renderAvatarImage` export function doesn't need locale since it only uses initials and image alt text
---

## 2026-02-26 20:35 - US-010
- Extracted and translated all Settings page strings across all 3 tabs (General, Migrations, Database Tools)
- Files changed:
  - `packages/core/src/i18n/locales/en.ts` — added `settings` namespace with 60+ keys (page header, tab labels, general settings fields, migration status/actions/history, database tools stats/operations/danger zone, all client-side JS strings)
  - `packages/core/src/i18n/locales/pt.ts` — Portuguese translations for settings namespace
  - `packages/core/src/i18n/locales/es.ts` — Spanish translations for settings namespace
  - `packages/core/src/templates/pages/admin-settings.template.ts` — imported `t`, replaced all hardcoded strings with t() calls; added locale param to `renderTabContent()`, `renderGeneralSettings()`, `renderMigrationSettings()`, `renderDatabaseToolsSettings()`; injected `window.__i18n` for 30+ client-side JS strings; passed locale to layout data and confirmation dialog
- **Learnings for future iterations:**
  - Settings template has duplicate script blocks — one in `renderSettingsPage()` and one in `renderMigrationSettings()` — both need i18n updates for the same functions
  - The `window.__i18n` object for settings is large (30+ keys) because all 3 tabs have client-side JS with alert/prompt/button text
  - Truncate prompt uses `prompt()` with TRUNCATE ALL DATA confirmation — the prompt text is translated but the confirmation keyword stays in English
  - Language dropdown in General settings has static options (en/es/fr/de) — this is separate from the i18n system and will be wired in US-015
  - Confirmation dialog for "Run Migrations" reuses `t('common.cancel', locale)` for the cancel button — good pattern for reusing common namespace
---
